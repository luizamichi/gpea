from bs4 import BeautifulSoup
import csv, requests

# URL DA ACTION DO FORMULÁRIO (http://www4.pr.gov.br/escolas/frmPesquisaEscolas.jsp)
url = 'http://www4.pr.gov.br/escolas/listaescolas.jsp'

# DICIONÁRIO COM OS PARÂMETROS E VALORES A SEREM PASSADOS PARA O SERVIDOR
post = {
	'NomeNre': 0, # NÚCLEO DE EDUCAÇÃO
	'NomeMun': 0, # MUNICÍPIO
	'DescrRedeEnsino': 0, # REDE DE ENSINO
	'CodNre': 0, # CÓDIGO DO NÚCLEO DE EDUCAÇÃO
	'CodMun': 0, # CÓDIGO DO MUNICÍPO
	'CodRedeEnsino': 2, # CÓDIGO DA REDE DE ENSINO
	'Ano': 0, # REFERÊNCIA
	'btn_cons': 'Consultar'
}

# DICIONÁRIO COM OS NÚCLEOS DE EDUCAÇÃO APONTANDO PARA O CÓDIGO
nucleo_de_educacao = {'Todos': 0, 'Não Informado': 99, 'APUCARANA': 1, 'AREA METROP.NORTE': 2, 'AREA METROP.SUL': 3, 'ASSIS CHATEAUBRIAN': 4, 'CAMPO MOURAO': 5, 'CASCAVEL': 6, 'CIANORTE': 7, 'CORNELIO PROCOPIO': 8, 'CURITIBA': 9, 'DOIS VIZINHOS': 10, 'FOZ DO IGUACU': 11, 'FRANCISCO BELTRAO': 12, 'GOIOERE': 13, 'GUARAPUAVA': 14, 'IBAITI': 32, 'IRATI': 15, 'IVAIPORA': 16, 'JACAREZINHO': 17, 'LARANJEIRAS DO SUL': 31, 'LOANDA': 20, 'LONDRINA': 18, 'MARINGA': 19, 'PARANAGUA': 21, 'PARANAVAI': 22, 'PATO BRANCO': 23, 'PITANGA': 24, 'PONTA GROSSA': 25, 'TELEMACO BORBA': 26, 'TOLEDO': 27, 'UMUARAMA': 28, 'UNIAO DA VITORIA': 29, 'WENCESLAU BRAZ': 30}

# DICIONÁRIO COM OS MUNICÍPOS APONTANDO PARA O CÓDIGO
municipios = {'Todos': 0, 'ABATIA': 10, 'ADRIANOPOLIS': 20, 'AGUDOS DO SUL': 30, 'ALMIRANTE TAMANDARE': 40, 'ALTAMIRA DO PARANA': 44, 'ALTO PARAISO': 2872, 'ALTO PARANA': 50, 'ALTO PIQUIRI': 60, 'ALTONIA': 70, 'ALVORADA DO SUL': 80, 'AMAPORA': 90, 'AMPERE': 100, 'ANAHY': 104, 'ANDIRA': 110, 'ANGULO': 114, 'ANTONINA': 120, 'ANTONIO OLINTO': 130, 'APUCARANA': 140, 'ARAPONGAS': 150, 'ARAPOTI': 160, 'ARAPUA': 164, 'ARARUNA': 170, 'ARAUCARIA': 180, 'ARIRANHA DO IVAI': 184, 'ASSAI': 190, 'ASSIS CHATEAUBRIAND': 200, 'ASTORGA': 210, 'ATALAIA': 220, 'BALSA NOVA': 230, 'BANDEIRANTES': 240, 'BARBOSA FERRAZ': 250, 'BARRA DO JACARE': 270, 'BARRACAO': 260, 'BELA VISTA DA CAROBA': 274, 'BELA VISTA DO PARAISO': 280, 'BITURUNA': 290, 'BOA ESPERANCA': 300, 'BOA ESPERANCA DO IGUACU': 302, 'BOA VENTURA DE SAO ROQUE': 303, 'BOA VISTA DA APARECIDA': 304, 'BOCAIUVA DO SUL': 310, 'BOM JESUS DO SUL': 314, 'BOM SUCESSO': 320, 'BOM SUCESSO DO SUL': 324, 'BORRAZOPOLIS': 330, 'BRAGANEY': 334, 'BRASILANDIA DO SUL': 338, 'CAFEARA': 340, 'CAFELANDIA': 344, 'CAFEZAL DO SUL': 347, 'CALIFORNIA': 350, 'CAMBARA': 360, 'CAMBE': 370, 'CAMBIRA': 380, 'CAMPINA DA LAGOA': 390, 'CAMPINA DO SIMAO': 394, 'CAMPINA GRANDE DO SUL': 400, 'CAMPO BONITO': 404, 'CAMPO DO TENENTE': 410, 'CAMPO LARGO': 420, 'CAMPO MAGRO': 424, 'CAMPO MOURAO': 430, 'CANDIDO DE ABREU': 440, 'CANDOI': 442, 'CANTAGALO': 444, 'CAPANEMA': 450, 'CAPITAO LEONIDAS MARQUES': 460, 'CARAMBEI': 464, 'CARLOPOLIS': 471, 'CASCAVEL': 480, 'CASTRO': 490, 'CATANDUVAS': 500, 'CENTENARIO DO SUL': 510, 'CERRO AZUL': 520, 'CEU AZUL': 530, 'CHOPINZINHO': 540, 'CIANORTE': 550, 'CIDADE GAUCHA': 560, 'CLEVELANDIA': 570, 'COLOMBO': 580, 'COLORADO': 590, 'CONGONHINHAS': 600, 'CONSELHEIRO MAIRINCK': 611, 'CONTENDA': 620, 'CORBELIA': 630, 'CORNELIO PROCOPIO': 640, 'CORONEL DOMINGOS SOARES': 644, 'CORONEL VIVIDA': 650, 'CORUMBATAI DO SUL': 654, 'CRUZ MACHADO': 660, 'CRUZEIRO DO IGUACU': 664, 'CRUZEIRO DO OESTE': 670, 'CRUZEIRO DO SUL': 680, 'CRUZMALTINA': 684, 'CURITIBA': 690, 'CURIUVA': 700, 'DIAMANTE DO NORTE': 710, 'DIAMANTE DO OESTE': 715, 'DIAMANTE DO SUL': 713, 'DOIS VIZINHOS': 720, 'DOURADINA': 724, 'DOUTOR CAMARGO': 730, 'DOUTOR ULYSSES': 734, 'ENEAS MARQUES': 740, 'ENGENHEIRO BELTRAO': 750, 'ENTRE RIOS DO OESTE': 753, 'ESPERANCA NOVA': 755, 'ESPIGAO ALTO DO IGUACU': 756, 'FAROL': 757, 'FAXINAL': 760, 'FAZENDA RIO GRANDE': 764, 'FENIX': 770, 'FERNANDES PINHEIRO': 772, 'FIGUEIRA': 774, 'FLOR DA SERRA DO SUL': 777, 'FLORAI': 780, 'FLORESTA': 790, 'FLORESTOPOLIS': 800, 'FLORIDA': 810, 'FORMOSA DO OESTE': 820, 'FOZ DO IGUACU': 830, 'FOZ DO JORDAO': 834, 'FRANCISCO ALVES': 840, 'FRANCISCO BELTRAO': 850, 'GENERAL CARNEIRO': 860, 'GODOY MOREIRA': 865, 'GOIOERE': 870, 'GOIOXIM': 875, 'GRANDES RIOS': 880, 'GUAIRA': 890, 'GUAIRACA': 900, 'GUAMIRANGA': 914, 'GUAPIRAMA': 910, 'GUAPOREMA': 920, 'GUARACI': 930, 'GUARANIACU': 940, 'GUARAPUAVA': 950, 'GUARAQUECABA': 960, 'GUARATUBA': 970, 'HONORIO SERPA': 974, 'IBAITI': 980, 'IBEMA': 985, 'IBIPORA': 990, 'ICARAIMA': 1000, 'IGUARACU': 1010, 'IGUATU': 1014, 'IMBAU': 1017, 'IMBITUVA': 1020, 'INACIO MARTINS': 1030, 'INAJA': 1040, 'INDIANOPOLIS': 1050, 'IPIRANGA': 1060, 'IPORA': 1070, 'IRACEMA DO OESTE': 1074, 'IRATI': 1080, 'IRETAMA': 1090, 'ITAGUAJE': 1100, 'ITAIPULANDIA': 1104, 'ITAMBARACA': 1110, 'ITAMBE': 1120, 'ITAPEJARA DO OESTE': 1130, 'ITAPERUCU': 1134, 'ITAUNA DO SUL': 1140, 'IVAI': 1150, 'IVAIPORA': 1160, 'IVATE': 1165, 'IVATUBA': 1170, 'JABOTI': 1180, 'JACAREZINHO': 1190, 'JAGUAPITA': 1200, 'JAGUARIAIVA': 1210, 'JANDAIA DO SUL': 1220, 'JANIOPOLIS': 1230, 'JAPIRA': 1240, 'JAPURA': 1250, 'JARDIM ALEGRE': 1260, 'JARDIM OLINDA': 1270, 'JATAIZINHO': 1280, 'JESUITAS': 1284, 'JOAQUIM TAVORA': 1290, 'JUNDIAI DO SUL': 1300, 'JURANDA': 1304, 'JUSSARA': 1310, 'KALORE': 1320, 'LAPA': 1330, 'LARANJAL': 1334, 'LARANJEIRAS DO SUL': 1340, 'LEOPOLIS': 1350, 'LIDIANOPOLIS': 1353, 'LINDOESTE': 1355, 'LOANDA': 1360, 'LOBATO': 1370, 'LONDRINA': 1380, 'LUIZIANA': 1382, 'LUNARDELLI': 1384, 'LUPIONOPOLIS': 1390, 'MALLET': 1400, 'MAMBORE': 1410, 'MANDAGUACU': 1420, 'MANDAGUARI': 1430, 'MANDIRITUBA': 1440, 'MANFRINOPOLIS': 1444, 'MANGUEIRINHA': 1450, 'MANOEL RIBAS': 1460, 'MARECHAL CANDIDO RONDON': 1470, 'MARIA HELENA': 1480, 'MARIALVA': 1490, 'MARILANDIA DO SUL': 1500, 'MARILENA': 1510, 'MARILUZ': 1520, 'MARINGA': 1530, 'MARIOPOLIS': 1540, 'MARIPA': 1544, 'MARMELEIRO': 1550, 'MARQUINHO': 1554, 'MARUMBI': 1560, 'MATELANDIA': 1570, 'MATINHOS': 1580, 'MATO RICO': 1584, 'MAUA DA SERRA': 1587, 'MEDIANEIRA': 1590, 'MERCEDES': 1594, 'MIRADOR': 1600, 'MIRASELVA': 1610, 'MISSAL': 1614, 'MOREIRA SALES': 1620, 'MORRETES': 1630, 'MUNHOZ DE MELLO': 1640, 'NOSSA SENHORA DAS GRACAS': 1650, 'NOVA ALIANCA DO IVAI': 1660, 'NOVA AMERICA DA COLINA': 1670, 'NOVA AURORA': 1680, 'NOVA CANTU': 1690, 'NOVA ESPERANCA': 1700, 'NOVA ESPERANCA DO SUDOESTE': 1704, 'NOVA FATIMA': 1710, 'NOVA LARANJEIRAS': 1714, 'NOVA LONDRINA': 1720, 'NOVA OLIMPIA': 1730, 'NOVA PRATA DO IGUACU': 1734, 'NOVA SANTA BARBARA': 1737, 'NOVA SANTA ROSA': 1740, 'NOVA TEBAS': 1745, 'NOVO ITACOLOMI': 1747, 'ORTIGUEIRA': 1750, 'OURIZONA': 1760, 'OURO VERDE DO OESTE': 1765, 'PAICANDU': 1770, 'PALMAS': 1780, 'PALMEIRA': 1790, 'PALMITAL': 1800, 'PALOTINA': 1810, 'PARAISO DO NORTE': 1820, 'PARANACITY': 1830, 'PARANAGUA': 1840, 'PARANAPOEMA': 1850, 'PARANAVAI': 1860, 'PATO BRAGADO': 1864, 'PATO BRANCO': 1870, 'PAULA FREITAS': 1880, 'PAULO FRONTIN': 1890, 'PEABIRU': 1900, 'PEROBAL': 1904, 'PEROLA': 1910, 'PEROLA DO OESTE': 1920, 'PIEN': 1930, 'PINHAIS': 1932, 'PINHAL DE SAO BENTO': 1934, 'PINHALAO': 1940, 'PINHAO': 1950, 'PIRAI DO SUL': 1960, 'PIRAQUARA': 1970, 'PITANGA': 1980, 'PITANGUEIRAS': 1984, 'PLANALTINA DO PARANA': 1990, 'PLANALTO': 2000, 'PONTA GROSSA': 2010, 'PONTAL DO PARANA': 2014, 'PORECATU': 2020, 'PORTO AMAZONAS': 2030, 'PORTO BARREIRO': 2034, 'PORTO RICO': 2040, 'PORTO VITORIA': 2050, 'PRADO FERREIRA': 2052, 'PRANCHITA': 2054, 'PRESIDENTE CASTELO BRANCO': 2060, 'PRIMEIRO DE MAIO': 2070, 'PRUDENTOPOLIS': 2080, 'QUARTO CENTENARIO': 2084, 'QUATIGUA': 2090, 'QUATRO BARRAS': 2100, 'QUATRO PONTES': 2104, 'QUEDAS DO IGUACU': 2110, 'QUERENCIA DO NORTE': 2120, 'QUINTA DO SOL': 2130, 'QUITANDINHA': 2140, 'RAMILANDIA': 2144, 'RANCHO ALEGRE': 2150, 'RANCHO ALEGRE DO OESTE': 2154, 'REALEZA': 2160, 'REBOUCAS': 2170, 'RENASCENCA': 2180, 'RESERVA': 2190, 'RESERVA DO IGUACU': 2194, 'RIBEIRAO CLARO': 2200, 'RIBEIRAO DO PINHAL': 2210, 'RIO AZUL': 2220, 'RIO BOM': 2230, 'RIO BONITO DO IGUACU': 2234, 'RIO BRANCO DO IVAI': 2238, 'RIO BRANCO DO SUL': 2240, 'RIO NEGRO': 2250, 'ROLANDIA': 2260, 'RONCADOR': 2270, 'RONDON': 2280, 'ROSARIO DO IVAI': 2284, 'SABAUDIA': 2290, 'SALGADO FILHO': 2300, 'SALTO DO ITARARE': 2310, 'SALTO DO LONTRA': 2320, 'SANTA AMELIA': 2330, 'SANTA CECILIA DO PAVAO': 2340, 'SANTA CRUZ DO MONTE CASTELO': 2350, 'SANTA FE': 2360, 'SANTA HELENA': 2371, 'SANTA INES': 2380, 'SANTA ISABEL DO IVAI': 2390, 'SANTA IZABEL DO OESTE': 2400, 'SANTA LUCIA': 2404, 'SANTA MARIA DO OESTE': 2407, 'SANTA MARIANA': 2410, 'SANTA MONICA': 2411, 'SANTA TEREZA DO OESTE': 2413, 'SANTA TEREZINHA DE ITAIPU': 2414, 'SANTANA DO ITARARE': 2420, 'SANTO ANTONIO DA PLATINA': 2430, 'SANTO ANTONIO DO CAIUA': 2440, 'SANTO ANTONIO DO PARAISO': 2450, 'SANTO ANTONIO DO SUDOESTE': 2460, 'SANTO INACIO': 2470, 'SAO CARLOS DO IVAI': 2480, 'SAO JERONIMO DA SERRA': 2490, 'SAO JOAO': 2500, 'SAO JOAO DO CAIUA': 2510, 'SAO JOAO DO IVAI': 2520, 'SAO JOAO DO TRIUNFO': 2530, 'SAO JORGE DO IVAI': 2540, 'SAO JORGE DO OESTE': 2550, 'SAO JORGE DO PATROCINIO': 2554, 'SAO JOSE DA BOA VISTA': 2560, 'SAO JOSE DAS PALMEIRAS': 2564, 'SAO JOSE DOS PINHAIS': 2570, 'SAO MANOEL DO PARANA': 2574, 'SAO MATEUS DO SUL': 2580, 'SAO MIGUEL DO IGUACU': 2590, 'SAO PEDRO DO IGUACU': 2594, 'SAO PEDRO DO IVAI': 2600, 'SAO PEDRO DO PARANA': 2610, 'SAO SEBASTIAO DA AMOREIRA': 2620, 'SAO TOME': 2630, 'SAPOPEMA': 2640, 'SARANDI': 2644, 'SAUDADE DO IGUACU': 2647, 'SENGES': 2650, 'SERRANOPOLIS DO IGUACU': 2654, 'SERTANEJA': 2660, 'SERTANOPOLIS': 2670, 'SIQUEIRA CAMPOS': 2680, 'SULINA': 2684, 'TAMARANA': 2688, 'TAMBOARA': 2690, 'TAPEJARA': 2700, 'TAPIRA': 2710, 'TEIXEIRA SOARES': 2720, 'TELEMACO BORBA': 2730, 'TERRA BOA': 2740, 'TERRA RICA': 2750, 'TERRA ROXA': 2760, 'TIBAGI': 2770, 'TIJUCAS DO SUL': 2780, 'TOLEDO': 2790, 'TOMAZINA': 2800, 'TRES BARRAS DO PARANA': 2804, 'TUNAS DO PARANA': 2807, 'TUNEIRAS DO OESTE': 2810, 'TUPASSI': 2814, 'TURVO': 2817, 'UBIRATA': 2820, 'UMUARAMA': 2830, 'UNIAO DA VITORIA': 2840, 'UNIFLOR': 2850, 'URAI': 2860, 'VENTANIA': 2862, 'VERA CRUZ DO OESTE': 2864, 'VERE': 2870, 'VIRMOND': 2878, 'VITORINO': 2880, 'WENCESLAU BRAZ': 2890, 'XAMBRE': 2900}

# LISTA COM AS REDES DE ENSINO DISPONÍVEIS
rede_de_ensino = {'Estadual': 2, 'Federal': 1, 'Municipal': 3, 'Particular': 4}

# LISTA COM OS ANOS PARA CONSULTA DISPONÍVEIS
referencia = [2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2012, 2011, 2010, 2009, 2008, 2007, 2006, 2005, 2004, 2003]

# LEITURA DOS DADOS
input1, input2, input3, input4 = '', '', '', 0
while input1 not in nucleo_de_educacao.keys():
	print('---------- Núcleo de Educação ----------')
	print(', '.join(nucleo_de_educacao.keys()))
	input1 = input().upper()
	if input1 in ['TODOS', 'NÃO INFORMADO']:
		input1 = input1.capitalize()
while input2 not in municipios.keys():
	print('-------------- Município ---------------')
	print(', '.join(municipios.keys()))
	input2 = input().upper()
	if input2 == 'TODOS':
		input2 = input2.capitalize()
while input3 not in rede_de_ensino.keys():
	print('------------ Rede de Ensino ------------')
	print(', '.join(rede_de_ensino.keys()))
	input3 = input().capitalize()
while input4 not in referencia:
	print('-------------- Referência --------------')
	print(referencia)
	input4 = int(input())

# MONTA OS PARÂMETROS POST
post['NomeNre'] = input1 # NÚCLEO DE EDUCAÇÃO
post['NomeMun'] = input2 # MUNICÍPIO
post['DescrRedeEnsino'] = input3 # REDE DE ENSINO
post['CodNre'] = nucleo_de_educacao[input1] # CÓDIGO DO NÚCLEO DE EDUCAÇÃO
post['CodMun'] = municipios[input2] # CÓDIGO DO MUNICÍPIO
post['CodRedeEnsino'] = rede_de_ensino[input3] # CÓDIGO DA REDE DE ENSINO
post['Ano'] = input4 # REFERÊNCIA

# REQUERE O URL DA PÁGINA
page = requests.post(url, data=post)

# APLICA TRANSFORMAÇÕES PARA OBTER OS HIPERLINKS DE CADA LINHA DA TABELA
soup = BeautifulSoup(page.text, 'html.parser')
tags = soup.find_all('td', {'colspan': '2', 'nowrap': ''})
enderecos = []
for tag in tags:
	if tag.get('onclick'):
		enderecos.append(tag.get('onclick'))

# RECEBE O CONTEÚDO DAS NOVAS PÁGINAS
pages = []
for endereco in enderecos:
	pages.append(requests.get('http://www4.pr.gov.br/escolas/' + endereco[13:-2]))

# APLICA AS TRANSFORMAÇÕES PARA MODELAR OS DADOS
arquivo = open('dados.txt', 'a')
for page in pages:
	soup = BeautifulSoup(page.text, 'html.parser')
	conteudo = soup.find_all('font', {'face': 'verdana', 'size': '2'})
	for linha in conteudo:
		texto = BeautifulSoup(str(linha), 'html.parser')
		arquivo.write(texto.get_text().strip().replace(' ', '').replace('  ', '').replace('	', '').replace('\r\n', '').replace('Número', '\nNúmero').replace('Localização Geográfica:', '').replace('Fotos:', '') + '\n')
	arquivo.write('\n')
arquivo.close()

# SALVA TODOS OS ENDEREÇOS DE E-MAIL EM UM ARQUIVO CSV
arquivo = open('dados.txt', 'r')
with open('dados.csv', 'a', newline='', encoding='utf-8') as arquivo_csv:
	cabecalho = ['email']
	writer = csv.DictWriter(arquivo_csv, fieldnames=cabecalho)
	# writer.writerow({'email': input1 + ' - ' + input2 + ' (' + input3 + ' - ' + str(input4) + ')'}) # CABEÇALHO DO CSV
	for linha in arquivo:
		if linha[:5] == 'Email':
			writer.writerow({'email': linha[7:-1]})
	# writer.writerow({'email': ''}) # QUEBRA A ÚLTIMA LINHA
arquivo.close()